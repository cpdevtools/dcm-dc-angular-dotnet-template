"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Package = void 0;
const dependency_graph_1 = require("dependency-graph");
const fast_glob_1 = __importDefault(require("fast-glob"));
const fs_1 = __importDefault(require("fs"));
const linq_1 = __importDefault(require("linq"));
const posix_1 = __importDefault(require("path/posix"));
const index_js_1 = require("../../utils/index.js");
const PackageManager_1 = require("../PackageManager");
const WorkspaceCallError_1 = require("../WorkspaceCallError");
const WorkspaceCallSuccess_1 = require("../WorkspaceCallSuccess");
class Package {
    constructor(data, path, filename) {
        Object.defineProperty(this, "_path", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
        Object.defineProperty(this, "_file", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
        Object.defineProperty(this, "_data", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: {}
        });
        Object.defineProperty(this, "_workspaceQuery", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
        this._path = path;
        this._file = filename;
        this._data = data;
    }
    get path() {
        return this._path;
    }
    get fileName() {
        return this._file;
    }
    get fileType() {
        return posix_1.default.extname(this._file);
    }
    get data() {
        return this._data;
    }
    get name() {
        return this.data.name;
    }
    get version() {
        return this.data.version;
    }
    get dependencies() {
        var _a;
        (_a = this.data).dependencies ?? (_a.dependencies = {});
        return this.data.dependencies;
    }
    get devDependencies() {
        var _a;
        (_a = this.data).devDependencies ?? (_a.devDependencies = {});
        return this.data.devDependencies;
    }
    get peerDependencies() {
        var _a;
        (_a = this.data).peerDependencies ?? (_a.peerDependencies = {});
        return this.data.peerDependencies;
    }
    get optionalDependencies() {
        var _a;
        (_a = this.data).optionalDependencies ?? (_a.optionalDependencies = {});
        return this.data.optionalDependencies;
    }
    get dependencyNames() {
        return Object.keys(this.dependencies);
    }
    get devDependencyNames() {
        return Object.keys(this.devDependencies);
    }
    get peerDependencyNames() {
        return Object.keys(this.peerDependencies);
    }
    get optionalDependencyNames() {
        return Object.keys(this.optionalDependencies);
    }
    async execCmd(cmd) {
        const chalk = await (0, index_js_1.importChalk)();
        this.logInfo(chalk.blueBright(`Executing: ${chalk.gray(cmd)}`));
        return await (0, index_js_1.exec)(cmd, { cwd: this.path });
    }
    get scripts() {
        var _a;
        (_a = this.data).scripts ?? (_a.scripts = {});
        return this.data.scripts;
    }
    hasScript(scriptName) {
        return !!this.scripts[scriptName]?.trim();
    }
    async runScript(script, options) {
        const chalk = await (0, index_js_1.importChalk)();
        const opts = {
            ...options,
            throwOnError: options?.throwOnError ?? true,
            throwOnMissing: options?.throwOnMissing ?? true,
        };
        const scriptName = script.split(/\s/, 1)[0].trim();
        if (!this.hasScript(scriptName)) {
            if (opts?.throwOnMissing !== false) {
                this.logError(`Package does't have a script named '${chalk.cyanBright(scriptName)}'`);
                throw new Error(`Package does't have a script named '${scriptName}'`);
            }
            this.logInfo(`Package does't have a script named '${chalk.cyanBright(scriptName)}'. Skipping...`);
            return undefined;
        }
        this.logInfo(chalk.green(`Running ${chalk.cyanBright(scriptName)}`));
        let code = await this.execPackageScript(script);
        if (code !== 0) {
            if (opts?.throwOnError !== false) {
                this.logError(`Script '${chalk.cyanBright(scriptName)}' failed with exit code ${chalk.redBright(code)}`);
                throw new Error(`Script '${scriptName}' failed with exit code ${code}`);
            }
        }
        return code;
    }
    execPackageScript(script) {
        return this.execPackageManager(`run ${script}`);
    }
    get isWorkspace() {
        return !!this.data.workspaces;
    }
    get workspaces() {
        var _a;
        return ((_a = this.data).workspaces ?? (_a.workspaces = []));
    }
    async _workspaceQueryFactory() {
        const base = linq_1.default.from(Array.isArray(this.workspaces)
            ? this.data.workspaces
            : Array.isArray(this.workspaces.packages)
                ? this.workspaces.packages
                : []).select((p) => {
            const result = (0, fast_glob_1.default)(p, { cwd: this.path, onlyDirectories: true });
            return result;
        });
        const packages = linq_1.default.from(await Promise.all(linq_1.default.from(await Promise.all(base.toArray()))
            .selectMany((paths) => paths)
            .select((p) => (posix_1.default.isAbsolute(p) ? p : posix_1.default.join(this.path, p)))
            .where((p) => fs_1.default.existsSync(posix_1.default.join(p, "package.json")))
            .select((p) => PackageManager_1.PackageManager.loadPackage(p)))).orderBy((p) => p.name);
        return packages.asEnumerable();
    }
    get workspaceQuery() {
        return (this._workspaceQuery ?? (this._workspaceQuery = this._workspaceQueryFactory()));
    }
    async listWorkspacePackages() {
        return (await this.workspaceQuery).toArray();
    }
    async listWorkspaceNames() {
        return (await this.workspaceQuery).select((p) => p.name).toArray();
    }
    async workspaceExecute(cmd, options) {
        return this.workspaceCall(async (pkg) => {
            return await pkg.execCmd(cmd);
        }, options);
    }
    workspaceRunScript(cmd, options) {
        return this.workspaceCall(async (pkg) => {
            return await pkg.runScript(cmd, options);
        }, options);
    }
    async workspaceCall(fn, options) {
        const opt = this._applyWorkspaceSortingOptionDefaults(options);
        opt.throwOnError ?? (opt.throwOnError = false);
        const sequence = await this._buildWorkspaceWalkingOrder(opt);
        const results = [];
        for (const parallel of sequence) {
            const parallelPromises = [];
            for (const pkg of parallel) {
                const fnWrapper = async (pkg) => {
                    try {
                        const result = await fn(pkg);
                        return {
                            package: pkg,
                            result: result,
                            success: true,
                        };
                    }
                    catch (e) {
                        if (opt.throwOnError) {
                            throw e;
                        }
                        return {
                            package: pkg,
                            error: e,
                            success: false,
                        };
                    }
                };
                const promise = fnWrapper(pkg);
                parallelPromises.push(promise);
            }
            const result = await Promise.all(parallelPromises);
            results.push(...result);
        }
        const resultsQuery = linq_1.default.from(results);
        const rError = resultsQuery.where((r) => (0, WorkspaceCallError_1.isWorkspaceCallError)(r)).cast();
        const rSuccess = resultsQuery.where((r) => (0, WorkspaceCallSuccess_1.isWorkspaceCallSuccess)(r)).cast();
        return {
            hasErrors: rError.any(),
            errors: rError.toArray(),
            results: rSuccess.toArray(),
        };
    }
    _applyWorkspaceSortingOptionDefaults(options) {
        return {
            ...options,
            parallel: options.parallel ?? false,
            dependencies: options.dependencies ?? false,
            devDependencies: options.devDependencies ?? false,
            optionalDependencies: options.optionalDependencies ?? false,
            peerDependencies: options.peerDependencies ?? false,
        };
    }
    async _buildWorkspaceWalkingOrder(options) {
        let packages = [];
        if (options.dependencies || options.devDependencies || options.peerDependencies || options.optionalDependencies) {
            packages = await this._buildWorkspaceDependencyArray(options);
            if (!options.parallel) {
                packages = packages.flat().map((p) => [p]);
            }
        }
        else {
            const q = await this.workspaceQuery;
            if (options.parallel) {
                packages = [q.toArray()];
            }
            else {
                packages = q.select((p) => [p]).toArray();
            }
        }
        return packages;
    }
    async _buildWorkspaceDependencyArray(opts) {
        const runOrder = [];
        const depGraph = (await this._buildWorkspaceDependencyGraph(opts)).clone();
        let packages = depGraph.overallOrder(true).map((name) => depGraph.getNodeData(name));
        while (packages?.length) {
            runOrder.push(packages);
            packages.forEach((p) => depGraph.removeNode(p.name));
            packages = depGraph.overallOrder(true).map((name) => depGraph.getNodeData(name));
        }
        return runOrder;
    }
    async _buildWorkspaceDependencyGraph(opts) {
        const depGraph = new dependency_graph_1.DepGraph();
        const packagesQuery = await this.workspaceQuery;
        packagesQuery.forEach((pkg) => {
            depGraph.addNode(pkg.name, pkg);
        });
        const deps = packagesQuery.select((p) => ({
            name: p.name,
            deps: [
                ...(!opts.dependencies ? [] : p.dependencyNames),
                ...(!opts.devDependencies ? [] : p.devDependencyNames),
                ...(!opts.peerDependencies ? [] : p.peerDependencyNames),
                ...(!opts.optionalDependencies ? [] : p.optionalDependencyNames),
            ],
        }));
        deps.forEach((p) => {
            p.deps.forEach((d) => {
                depGraph.addDependency(p.name, d);
            });
        });
        return depGraph;
    }
    async printLog(msg) {
        const chalk = await (0, index_js_1.importChalk)();
        return chalk.white(chalk.blueBright(`[${chalk.yellow(this.name)}]`) + ` ${msg}`);
    }
    async logInfo(msg) {
        const chalk = await (0, index_js_1.importChalk)();
        console.info(`${chalk.bgGray.black.bold(" Info ")} ${this.printLog(msg)}`);
    }
    async logWarn(msg) {
        const chalk = await (0, index_js_1.importChalk)();
        console.warn(`${chalk.bgYellow.black.bold(" Warning ")} ${this.printLog(msg)}`);
    }
    async logError(msg) {
        const chalk = await (0, index_js_1.importChalk)();
        console.error(`${chalk.bgRed.white.bold(" ERROR ")} ${this.printLog(msg)}`);
    }
    async install() {
        return await this.execPackageManager("install");
    }
    async workspaceInstall(options) {
        return this.workspaceCall(async (pkg) => {
            return await pkg.install();
        }, options);
    }
}
exports.Package = Package;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFja2FnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wYWNrYWdlLW1hbmFnZXJzL2ltcGwvUGFja2FnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSx1REFBNEM7QUFDNUMsMERBQTZCO0FBQzdCLDRDQUF3QjtBQUN4QixnREFBOEI7QUFDOUIsdURBQThCO0FBRTlCLG1EQUF5RDtBQUV6RCxzREFBbUQ7QUFFbkQsOERBQWlGO0FBRWpGLGtFQUF1RjtBQUd2RixNQUFzQixPQUFPO0lBSzNCLFlBQW1CLElBQWlCLEVBQUUsSUFBWSxFQUFFLFFBQWdCO1FBSnBFOzs7OztXQUErQjtRQUMvQjs7Ozs7V0FBK0I7UUFDL0I7Ozs7bUJBQTBELEVBQUU7V0FBQztRQXFKN0Q7Ozs7O1dBQTJFO1FBbEp6RSxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsS0FBSyxHQUFHLFFBQVEsQ0FBQztRQUN0QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQWdELENBQUM7SUFDaEUsQ0FBQztJQUVELElBQVcsSUFBSTtRQUNiLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRUQsSUFBVyxRQUFRO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRUQsSUFBVyxRQUFRO1FBQ2pCLE9BQU8sZUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELElBQWMsSUFBSTtRQUNoQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDcEIsQ0FBQztJQUVELElBQVcsSUFBSTtRQUNiLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDeEIsQ0FBQztJQUVELElBQVcsT0FBTztRQUNoQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQzNCLENBQUM7SUFFRCxJQUFX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